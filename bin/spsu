#! /bin/bash

# Sparky SU allowing users to give a password
# and run graphical commands as root
#
# Created by Pawe≈Ç "pavroo" Pijanowski 2018/12/16
# Inspired by Graphical frontend for su(1) script
# from https://sourceforge.net/p/yad-dialog/wiki/Examples/
# Copyright 2018-2020 under the GNU GPL3 License
# Last updated 2020/05/02

# get default's locale file
DEFLOCDIR="/usr/share/sparky/sparky-su"
if [ "`cat /etc/default/locale | grep de`" != "" ]; then
. $DEFLOCDIR/de
elif [ "`cat /etc/default/locale | grep el`" != "" ]; then
. $DEFLOCDIR/el
elif [ "`cat /etc/default/locale | grep fr`" != "" ]; then
. $DEFLOCDIR/fr
elif [ "`cat /etc/default/locale | grep hu`" != "" ]; then
. $DEFLOCDIR/hu
elif [ "`cat /etc/default/locale | grep it`" != "" ]; then
. $DEFLOCDIR/it
elif [ "`cat /etc/default/locale | grep pl`" != "" ]; then
. $DEFLOCDIR/pl
elif [ "`cat /etc/default/locale | grep pt_BR`" != "" ]; then
. $DEFLOCDIR/pt_BR
elif [ "`cat /etc/default/locale | grep ru`" != "" ]; then
. $DEFLOCDIR/ru
elif [ "`cat /etc/default/locale | grep zh_CN`" != "" ]; then
. $DEFLOCDIR/zh_CN
else
. $DEFLOCDIR/en
fi

CMD="$*"

if [ "$CMD" = "" ]; then
	echo ""
	echo "spsu usage is as follows:"
	echo "spsu command"
	echo ""
	exit 1
fi

#CLEARCMD=`echo "$CMD" | sed -e 's|./||'`

mainmenu () {
# get password
PASS=$(yad --class="GSu" \
    --width=400 \
    --center \
    --title="$LOCAL1" \
    --text="\n$LOCAL2 <b>root</b>\n$LOCAL3: $CMD \n" \
    --image="dialog-password" \
    --window-icon="dialog-password" \
    --entry --hide-text)
}

passmenu () {
if [ "$PASS" = "" ]; then
	echo "$LOCAL4"
	yad --button=Ok:0 \
	--title="$LOCAL1" \
	--width=400 --center \
	--image="dialog-password" \
	--window-icon="dialog-password" \
	--text="$LOCAL4"
	mainmenu
fi
}

passcheckmenu () {
if [ "$PASS" != "" ]; then
	sudo sparky-pass-check root $PASS
	if [ -f /tmp/sparky-passcheck ]; then
		CHECKPASS=`cat /tmp/sparky-passcheck | grep true`
		if [ "$CHECKPASS" = "" ]; then
		echo "$LOCAL5 root !"
			yad --button=Ok:0 \
			--title="$LOCAL1" \
			--width=400 --center \
			--image="dialog-password" \
			--window-icon="dialog-password" \
			--text="$LOCAL5 root ! \n$LOCAL6"
			mainmenu
		fi
	fi
fi
}

runmenu () {
# grant access to xserver for root user
xhost +root@ &> /dev/null

# run command
SPIN="$(mktemp -u --tmpdir spsu.in.XXXXXXXXX)"
SPOUT="$(mktemp -u --tmpdir spsu.out.XXXXXXXXX)"

export PATH=$PATH:/usr/local/bin:/bin:/usr/bin:/sbin:/usr/sbin
LC_MESSAGES=C empty -f -i $SPIN -o $SPOUT su -p root -c "$CMD"
[[ $? -eq 0 ]] && empty -w -i $SPOUT -o $SPIN "word:" "$PASS\n"
}

mainmenu
passmenu
passcheckmenu
runmenu
